<?xml version="1.0" encoding="UTF-8" ?>
 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.worksmobile.assignment.mapper.BoardMapper">
	
   <!-- offset위치부터 noOfRecords 수 만큼 select 한다. -->
   <select id="articleList" resultType="com.worksmobile.assignment.model.Board" parameterType="hashmap">
		SELECT board_id,version,subject,content,created_time,file_id,root_board_id 
		FROM board
		LIMIT #{offset}, #{noOfRecords};  
	</select>
	
	<select id="articleGetCount" resultType="int">
		SELECT count(*) 
		FROM board
	</select>
	    
    <select id="viewDetail" parameterType="hashmap" resultType="com.worksmobile.assignment.model.Board" >
    	SELECT board_id,version,subject,content,created_time,file_id,root_board_id
    	FROM board
    	WHERE board_id = #{board_id} AND version = #{version};
    </select>
    
	<!--  board_history와 동시에 넣어져야함. -->
    <insert id="createBoard" parameterType="com.worksmobile.assignment.model.Board">
        INSERT INTO board
        (board_id,version,subject,content,created_time,file_id,root_board_id)
        VALUES (#{board_id}, #{version},#{subject},#{content},#{created_time},#{file_id},#{root_board_id});

        <selectKey keyProperty="created_time" resultType="com.worksmobile.assignment.model.Board" order="AFTER">
     		SELECT created_time FROM board
     		WHERE board_id = #{board_id} AND version = #{version};
     	</selectKey>
    </insert>
    
    <delete id="deleteBoard" parameterType="hashmap">
        DELETE FROM board 
        WHERE board_id = #{board_id} AND version = #{version} ;
    </delete>
    
    <!--  히스토리 먼저 처리하고 boardUpdate 실행됨 -->
    <update id="boardUpdate" parameterType="hashmap">
        UPDATE board 
        SET 
        subject = #{subject},
        content = #{content},
        created_time = CURRENT_TIMESTAMP,
        file_id = #{file_id},
        root_board_id = #{root_board_id}
        WHERE board_id = #{board_id} AND version = #{version};
        <selectKey keyProperty="created_time" resultType="com.worksmobile.assignment.model.Board" order="AFTER">
     		SELECT created_time FROM board
     		WHERE board_id = #{board_id} AND version = #{version};
     	</selectKey>
    </update>
    
     <update id="boardUpdateWithoutFile" parameterType="hashmap">
        UPDATE board 
        SET 
        subject = #{subject},
        content = #{content},
        created_time = CURRENT_TIMESTAMP,
        root_board_id = #{root_board_id}
        WHERE board_id = #{board_id} AND version = #{version};
        <selectKey keyProperty="created_time" resultType="com.worksmobile.assignment.model.Board" order="AFTER">
     		SELECT created_time FROM board
     		WHERE board_id = #{board_id} AND version = #{version};
     	</selectKey>
    </update>
    
    <select id="boardFileDownload" parameterType="hashmap" resultType="com.worksmobile.assignment.model.File">
        SELECT b.file_name, b.file_data, b.file_size
        FROM board as a
        JOIN file as b
        ON a.file_id = b.file_id
        WHERE board_id = #{board_id} AND version = #{version};
    </select>
    
    
    <select id="getBoardList" resultType="com.worksmobile.assignment.model.Board" >
    	SELECT board_id, version, subject, content, created_time, file_id, root_board_id
    	FROM board
    	WHERE board_id = #{board_id} AND version = #{version};
    </select>

</mapper>