<?xml version="1.0" encoding="UTF-8" ?>
 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.worksmobile.assignment.mapper.BoardHistoryMapper">
	<select id="selectHistoryByRootBoardId"
    resultType="com.worksmobile.assignment.model.BoardHistory">
        SELECT board_id, version, created_time, status,
        		history_subject, history_content, file_id, 
        		parent_board_id, parent_version, root_board_id
		FROM board_history
		WHERE root_board_id = #{root_board_id};
    </select>

    <select id="selectHistory" 
    resultType="com.worksmobile.assignment.model.BoardHistory">
        SELECT board_id, version, created_time, status, 
        		history_subject, history_content, file_id, 
        		parent_board_id, parent_version, root_board_id
		FROM board_history
		WHERE board_id = #{board_id} AND version = #{version};
    </select>
    
    <select id="selectAllHistory"
    resultType="com.worksmobile.assignment.model.BoardHistory">
    	SELECT board_id, version, created_time, status, 
        		history_subject, history_content, file_id, 
        		parent_board_id, parent_version, root_board_id
        FROM board_history
    </select>
    
    <delete id="deleteHistory" parameterType="int">
		DELETE FROM board_history
		WHERE board_id = #{board_id} AND version = #{version};
    </delete>
    
     <insert id="createHistory" parameterType="com.worksmobile.assignment.model.BoardHistory">
        INSERT INTO board_history(board_id, version, status,
        						history_subject, history_content, file_id,
        						parent_board_id, parent_version, root_board_id)
		VALUES(#{board_id}, #{version}, #{status}, #{history_subject},
				#{history_content}, #{file_id}, #{parent_board_id}, #{parent_version}, #{root_board_id});
		<selectKey keyProperty="board_id,created_time" resultType="com.worksmobile.assignment.model.BoardHistory" order="AFTER">
     		SELECT board_id, created_time FROM board_history
     		WHERE board_id =
     		<if test = "board_id == null">
     								LAST_INSERT_ID()
     		</if>
     		<if test = "board_id != null">
     								#{board_id}
     		</if>
     													AND version = #{version};
     	</selectKey>
    </insert>

    <update id="updateHistoryParentAndRoot" parameterType="com.worksmobile.assignment.model.BoardHistory">
		UPDATE board_history
		SET
		  parent_board_id = #{parent_board_id}, parent_version = #{parent_version}, root_board_id = #{root_board_id}
		WHERE
		  board_id = #{board_id} AND version = #{version};
    </update>

     <select id="selectChildren" 
    resultType="com.worksmobile.assignment.model.BoardHistory">
        SELECT board_id, version, created_time, status,
        		history_subject, history_content, file_id,
        		parent_board_id, parent_version, root_board_id
		FROM board_history
		WHERE parent_board_id = #{board_id} AND parent_version = #{version};
    </select>
    
    <select id="selectFileCount" parameterType ="int" resultType="int">
		SELECT count(*)
		FROM board_history
		WHERE file_id = #{file_id};  
	</select>
</mapper>